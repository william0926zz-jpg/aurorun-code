"use strict";const t=require("../../common/vendor.js"),d=require("../../api/auth.js"),g=require("../../utils/request.js"),c={data(){return{account:"",password:"",showPwd:!1,remember:!0,isLoading:!1,message:""}},computed:{isReady(){const e=this.account.trim(),s=this.password.trim(),o=/\d/.test(s);return e.length>0&&s.length>=8&&o},btnText(){return this.isLoading?"验证中...":this.message?this.message:this.isReady?"登录":"请完善信息"}},methods:{togglePwd(){this.showPwd=!this.showPwd},async doLogin(){if(!(!this.isReady||this.isLoading)){this.isLoading=!0,this.message="";try{const e=this.account.trim(),s=await d.login(e,this.password.trim(),this.remember);if(s.code===200&&s.data){g.api.setToken(s.data.token),s.data.refreshToken&&g.api.setRefreshToken(s.data.refreshToken);let o="blind";try{const n=t.index.getStorageSync("userRole_"+e),r=t.index.getStorageSync("userRole");o=n||r||"blind",t.index.setStorageSync("userRole",o)}catch{}o==="volunteer"?t.index.reLaunch({url:"/pages/volunteer/home"}):t.index.reLaunch({url:"/pages/home/home"});return}else this.message=s.message||"登录失败"}catch(e){console.error("登录错误:",e);const s=e.data&&e.data.message||e.message||"";e.statusCode===404||s.includes("不存在")||s.includes("未注册")||s.includes("not found")||s.toLowerCase().includes("not registered")?this.message="还未注册":e.statusCode===401?this.message=s||"账号或密码错误":e.statusCode&&e.data&&e.data.message?this.message=e.data.message:e.errMsg&&(e.errMsg.includes("fail")||e.errMsg.includes("CONNECTION"))?this.message="无法连接到服务器，请检查网络或后端服务":e.errMsg&&e.errMsg.includes("EMPTY_RESPONSE")?this.message="服务器无响应，请稍后重试":this.message=s||"网络错误，请稍后重试"}finally{this.isLoading=!1,this.message&&setTimeout(()=>{this.message=""},2e3)}}},goRegister(){t.index.navigateTo({url:"/pages/register/register"})}}};function u(e,s,o,n,r,a){return{a:r.account,b:t.o(t.m(i=>r.account=i.detail.value,{trim:!0})),c:!r.showPwd,d:r.password,e:t.o(i=>r.password=i.detail.value),f:t.t(r.showPwd?"隐藏":"显示"),g:t.o((...i)=>a.togglePwd&&a.togglePwd(...i)),h:r.remember?1:"",i:t.o(i=>r.remember=!r.remember),j:t.t(a.btnText),k:a.isReady?1:"",l:r.isLoading?1:"",m:!a.isReady||r.isLoading,n:t.o((...i)=>a.doLogin&&a.doLogin(...i)),o:t.o((...i)=>a.goRegister&&a.goRegister(...i))}}const h=t._export_sfc(c,[["render",u],["__scopeId","data-v-96dae4f1"]]);xhs.createPage(h);
