"use strict";const d=require("../common/vendor.js"),k=!1;let g="https://fwthugojqdue.sealosbja.site";try{const a=d.index.getSystemInfoSync();if(a.platform==="devtools")g="http://192.168.101.200:3000",console.log("[API配置] 微信开发者工具环境，使用本地后端 API 地址（局域网 IP，已配置 API Key）");else if(a.platform==="ios"||a.platform==="android")g="https://fwthugojqdue.sealosbja.site",console.log("[API配置] 小程序真机/体验版/正式版环境，使用生产环境 API 地址");else if(typeof window<"u"&&window.location){const e=window.location.hostname;e==="localhost"||e==="127.0.0.1"||e.startsWith("192.168.")?(g="http://localhost:3000",console.log("[API配置] 本地 H5 环境，使用本地后端 API 地址")):(g="https://fwthugojqdue.sealosbja.site",console.log("[API配置] 生产 H5 环境，使用生产环境 API 地址"))}}catch(a){console.warn("[API配置] 无法判断运行环境，使用生产环境 API 地址",a),g="https://fwthugojqdue.sealosbja.site"}g="http://192.168.101.200:3000";console.log("[API配置] 强制使用局域网 IP:",g);console.log("[API配置] 当前 API 地址:",g);const p={register:(a,e,s="blind")=>new Promise(n=>{setTimeout(()=>{n({code:200,message:"注册成功",data:{userId:"mock_user_"+Date.now(),token:"mock_token_"+Date.now(),refreshToken:"mock_refresh_"+Date.now(),role:s}})},800)}),login:(a,e,s)=>new Promise(n=>{setTimeout(()=>{n({code:200,message:"登录成功",data:{userId:"mock_user_123456",token:"mock_token_"+Date.now(),refreshToken:"mock_refresh_"+Date.now(),userInfo:{nickname:a.includes("@")?a.split("@")[0]:"用户"+a.slice(-4),avatar:""},role:(()=>{try{const t=d.index.getStorageSync("userRole_"+a),u=d.index.getStorageSync("userRole");return t||u||"blind"}catch{return"blind"}})()}})},800)}),logout:()=>new Promise(a=>{setTimeout(()=>{a({code:200,message:"退出成功"})},300)}),sendMessage:(a,e)=>new Promise(s=>{setTimeout(()=>{let n="";const t=e.toLowerCase();if(t.includes("你好")||t.includes("hello")||t.includes("hi"))n="你好！我是小暖，很高兴和你聊天。有什么想和我分享的吗？";else if(t.includes("焦虑")||t.includes("担心")||t.includes("紧张"))n="我理解你的感受。焦虑是很正常的情绪反应。你可以试着深呼吸，或者告诉我更多关于你现在的感受，我们一起面对。";else if(t.includes("难过")||t.includes("伤心")||t.includes("不开心"))n="听到你这么说，我为你感到心疼。难过的时候，有人陪伴是很重要的。我在这里陪着你，你可以慢慢说给我听。";else if(t.includes("谢谢")||t.includes("感谢"))n="不客气，能帮到你我很开心。记住，你并不孤单，我会一直在这里支持你。";else if(t.includes("帮助")||t.includes("怎么办"))n="我很愿意帮助你。虽然我不能直接解决所有问题，但我可以倾听你的想法，和你一起思考。你可以详细说说你的情况吗？";else{const u=["我理解你的感受。能告诉我更多细节吗？","听起来你正在经历一些困难。我在这里陪着你，你可以慢慢说。","感谢你愿意和我分享。每个人的感受都很重要，你的也不例外。","我明白这不容易。让我们一起面对，好吗？","你的感受我听到了。无论发生什么，你都不是一个人。"];n=u[Math.floor(Math.random()*u.length)]}s({code:200,message:"发送成功",data:{sessionId:a||"session_"+Date.now(),userMessage:e,aiResponse:n,analysis:{emotionalState:"平静",riskLevel:"低",psychologicalIssues:[],keyConcerns:[],suggestedApproach:"继续倾听和陪伴",supportiveKeywords:["理解","陪伴","支持"]}}})},1500)}),compareUserInfo:(a,e)=>{const s={};let n=0,t=0;if(a.age&&e.age){const r=Math.abs(parseInt(a.age)-parseInt(e.age)),o=Math.max(0,1-r/20);s.age={mine:a.age,other:e.age,match:o},n+=o,t++}if(a.height&&e.height){const r=Math.abs(parseInt(a.height)-parseInt(e.height)),o=Math.max(0,1-r/30);s.height={mine:a.height,other:e.height,match:o},n+=o,t++}if(a.weight&&e.weight){const r=Math.abs(parseInt(a.weight)-parseInt(e.weight)),o=Math.max(0,1-r/20);s.weight={mine:a.weight,other:e.weight,match:o},n+=o,t++}if(a.visionType&&e.visionType){const r=a.visionType===e.visionType?1:.5;s.visionType={mine:a.visionType,other:e.visionType,match:r},n+=r,t++}if(a.experience&&e.experience){const r=a.experience.toLowerCase(),o=e.experience.toLowerCase(),c=r.match(/\d+/g)||[],l=o.match(/\d+/g)||[];let i=.3;if(c.length>0&&l.length>0){const h=parseInt(c[0])||0,m=parseInt(l[0])||0,f=Math.abs(h-m);i=Math.max(.3,1-f/10)}s.experience={mine:a.experience,other:e.experience,match:i},n+=i,t++}if(a.runningArea&&e.runningArea){const r=a.runningArea.toLowerCase(),o=e.runningArea.toLowerCase(),c=r.includes(o)||o.includes(r)?.9:.3;s.runningArea={mine:a.runningArea,other:e.runningArea,match:c},n+=c,t++}const u=t>0?Math.round(n/t*100):0;return{comparison:s,matchScore:u}},startMatch:(a,e)=>new Promise(s=>{setTimeout(()=>{const n={userId:"matched_user_"+Date.now(),nickname:"跑步伙伴"+Math.floor(Math.random()*1e3),avatar:"",profile:{age:String(20+Math.floor(Math.random()*20)),height:String(160+Math.floor(Math.random()*20)),weight:String(50+Math.floor(Math.random()*20)),visionType:Math.random()>.5?"half":"full",experience:`${Math.floor(Math.random()*5)+1}年到${Math.floor(Math.random()*5)+3}年`,runningArea:["北京","上海","广州","深圳","杭州"][Math.floor(Math.random()*5)],remarks:""}},t=p.compareUserInfo(e,n.profile);s({code:200,message:"匹配成功",data:{matchId:"match_"+Date.now(),matchedUser:{userId:n.userId,nickname:n.nickname,avatar:n.avatar},matchScore:t.matchScore,comparison:t.comparison}})},2e3)})};class T{constructor(){this.baseURL=g,this.useMock=k}getToken(){try{return d.index.getStorageSync("token")||""}catch{return""}}setToken(e){try{d.index.setStorageSync("token",e||"")}catch{}}getRefreshToken(){try{return d.index.getStorageSync("refreshToken")||""}catch{return""}}setRefreshToken(e){try{d.index.setStorageSync("refreshToken",e||"")}catch{}}request(e,{method:s="GET",data:n={},header:t={}}={}){this.baseURL=g;const u=e.startsWith("/api/ai/chat/");if(this.useMock&&!u)return this.handleMockRequest(e,s,n);const r=this.getToken(),o={"Content-Type":"application/json",...t};return u&&(o["Cache-Control"]="no-cache, no-store, must-revalidate",o.Pragma="no-cache",o.Expires="0",o["X-Request-Id"]=`ai_${Date.now()}_${Math.random().toString(16).slice(2)}`),r&&(o.Authorization=`Bearer ${r}`),new Promise((c,l)=>{d.index.request({url:this.baseURL+e,method:s,data:n,header:o,success:i=>{if(i.statusCode>=200&&i.statusCode<300){const h=i.data||{};try{h.__http={statusCode:i.statusCode,requestUrl:this.baseURL+e,requestId:o["X-Request-Id"]||""}}catch{}h.code===401&&this.getRefreshToken()?this.refreshToken().then(m=>{m?this.request(e,{method:s,data:n,header:t}).then(c).catch(l):(this.setToken(""),this.setRefreshToken(""),c(h))}).catch(()=>{this.setToken(""),this.setRefreshToken(""),c(h)}):(h.code===401&&(this.setToken(""),this.setRefreshToken("")),c(h))}else{const h=i.data||{};l({errMsg:`请求失败: HTTP ${i.statusCode}`,statusCode:i.statusCode,data:h,message:h.message||h.error||`请求失败: HTTP ${i.statusCode}`})}},fail:i=>{if((e.includes("/api/auth/login")||e.includes("/api/auth/register"))&&i.errMsg&&(i.errMsg.includes("CONNECTION")||i.errMsg.includes("fail")))return console.warn("[API] 后端连接失败，登录/注册接口自动使用 Mock 数据"),this.handleMockRequest(e,s,n).then(c).catch(l);l({errMsg:i.errMsg||"网络请求失败",...i})}})})}handleMockRequest(e,s,n){return new Promise((t,u)=>{if(e==="/api/auth/register"&&s==="POST"){const{account:r,password:o,role:c="blind"}=n;if(!r||!o){t({code:400,message:"账号和密码不能为空"});return}if(o.length<6){t({code:400,message:"密码长度至少8位"});return}p.register(r,o,c).then(t);return}if(e==="/api/auth/login"&&s==="POST"){const{account:r,password:o}=n;if(!r||!o){t({code:400,message:"账号和密码不能为空"});return}if(o==="wrong"){t({code:401,message:"账号或密码错误"});return}p.login(r,o,n.remember).then(t);return}if(e==="/api/auth/logout"&&s==="POST"){p.logout().then(t);return}if(e==="/api/user/account"&&s==="DELETE"){setTimeout(()=>{t({code:200,message:"账号已删除"})},500);return}if(e==="/api/matches/start"&&s==="POST"){try{const r=d.index.getStorageSync("userProfile");if(!r){t({code:400,message:"请先完善个人信息"});return}const o=JSON.parse(r);p.startMatch(n.preferences||{},o).then(t)}catch{t({code:400,message:"获取用户信息失败"})}return}if(e==="/api/matches"&&s==="GET"){t({code:200,message:"获取成功",data:{list:[],total:0,page:n.page||1,pageSize:n.pageSize||10}});return}t({code:200,message:"Mock 模式：此接口需要真实后端支持",data:{}})})}async refreshToken(){const e=this.getRefreshToken();if(!e)return!1;try{const s=await this.request("/api/auth/refresh",{method:"POST",data:{refreshToken:e},header:{Authorization:""}});return s.code===200&&s.data?(this.setToken(s.data.token),this.setRefreshToken(s.data.refreshToken),!0):!1}catch{return!1}}get(e,s={}){return this.request(e,{method:"GET",data:s})}post(e,s={}){return this.request(e,{method:"POST",data:s})}put(e,s={}){return this.request(e,{method:"PUT",data:s})}delete(e,s={}){return this.request(e,{method:"DELETE",data:s})}}const w=new T;exports.api=w;
