"use strict";const o=require("../../common/vendor.js"),u=require("../../api/aiChat.js"),a=require("../../utils/request.js"),h=require("../../common/assets.js"),g={data(){return{messages:[],inputText:"",loading:!1,sessionId:null,scrollTop:0,sidebarVisible:!1,userInfo:{name:"",age:null,symptom:"",mood:5,recentConcern:""},savingInfo:!1,userInfoSaved:!1}},async onLoad(){if(!a.api.getToken()){o.index.showModal({title:"需要登录",content:"使用AI聊天功能需要先登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:i=>{i.confirm?o.index.reLaunch({url:"/pages/login/login"}):o.index.navigateBack()}});return}try{const i=await a.api.get("/health");console.log("AI调试 /health 响应:",i),i&&i.__http&&(console.log("AI调试 命中后端URL:",i.__http.requestUrl),console.log("AI调试 RequestId:",i.__http.requestId))}catch(i){if(console.warn("AI调试 /health 失败:",i),i.statusCode===401||i.code===401){a.api.setToken(""),a.api.setRefreshToken(""),o.index.showModal({title:"登录已过期",content:"您的登录已过期或token无效，请重新登录后使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",showCancel:!0,success:l=>{l.confirm?o.index.reLaunch({url:"/pages/login/login"}):o.index.navigateBack()}});return}}this.addMessage("assistant","你好，我是小暖，你的心理辅导伙伴。有什么想和我聊聊的吗？",!0)},methods:{async sendMessage(){var l,c;if(!this.inputText.trim()||this.loading)return;if(!a.api.getToken()){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:s=>{s.confirm&&o.index.reLaunch({url:"/pages/login/login"})}});return}const i=this.inputText.trim();this.inputText="",this.addMessage("user",i,!0),this.scrollToBottom(),this.loading=!0;try{if(!this.sessionId)try{const e=await u.createSession("与小暖的对话");if(e.code===200&&e.data&&e.data.sessionId)this.sessionId=e.data.sessionId;else{const n=e.message||((l=e.data)==null?void 0:l.message)||"创建会话失败";if(e.code===401||e.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:r=>{r.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}o.index.showToast({title:n,icon:"none",duration:3e3}),this.loading=!1;return}}catch(e){if(console.error("创建会话失败:",e),e.statusCode===401||e.code===401||e.message&&e.message.includes("Token无效")||e.message&&e.message.includes("已过期")){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:n=>{n.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}}),this.loading=!1;return}if(e.errMsg&&(e.errMsg.includes("EMPTY_RESPONSE")||e.errMsg.includes("request:fail")))o.index.showModal({title:"连接失败",content:"无法连接到后端服务器，请检查后端服务是否正在运行。",showCancel:!1,confirmText:"我知道了"});else{const n=e.message||e.errMsg||"创建会话失败，请稍后重试";o.index.showToast({title:n,icon:"none",duration:3e3})}this.loading=!1;return}const s=await u.sendMessage(this.sessionId,i);if(console.log("AI聊天响应:",{code:s.code,message:s.message,data:s.data,fullResult:s}),console.log("检查响应结果:",{code:s.code,hasData:!!s.data,dataType:typeof s.data,data:s.data}),s.code===200&&s.data){const e=s.data.aiResponse||s.data.response||s.data.content||s.data.text||s.data.message||"";console.log("解析后的AI回复:",{aiResponse:e,hasResponse:!!e,aiResponseLength:e?e.length:0,dataKeys:Object.keys(s.data||{}),rawData:s.data});const n=e?e.toLowerCase():"",r=n&&(n.includes("抱歉")&&n.includes("暂不可用")||n.includes("暂不可用")&&(n.includes("api")||n.includes("key"))||n.includes("请确保已配置")&&(n.includes("环境变量")||n.includes("openai_api_key"))||n.includes("无法回复")&&n.includes("稍后再试")||n.includes("openai_api_key")&&(n.includes("未配置")||n.includes("环境变量"))||n.includes("api key")&&(n.includes("not")||n.includes("missing")||n.includes("未配置"))||n.includes("api服务")&&n.includes("不可用"));if(e&&!r){console.log("✅ AI回复有效，准备添加到消息列表"),console.log("准备添加AI回复到消息列表:",e),s.data.sessionId&&(this.sessionId=s.data.sessionId),this.addMessage("assistant",e,!0),s.data.analysis&&console.log("心理分析:",s.data.analysis);return}else if(r){console.warn("⚠️ 检测到错误消息:",e);const d=e||"AI服务暂不可用";if(d.includes("OPENAI_API_KEY")||d.includes("API")&&d.includes("Key")||d.includes("环境变量")){console.error("❌ API Key配置错误，显示错误提示"),this.loading=!1,o.index.showModal({title:"AI服务配置问题",content:`后端服务器未配置 OpenAI API Key。

请检查后端服务器环境变量配置（OPENAI_API_KEY）。

如果已配置但仍显示此错误，请查看后端日志获取详细信息。

提示：如果使用本地开发，请确保本地后端服务正在运行并配置了 API Key。`,showCancel:!1,confirmText:"我知道了"});return}else{this.loading=!1,o.index.showToast({title:d,icon:"none",duration:3e3});return}}else{console.warn("后端返回成功，但缺少 AI 回复内容:",{result:s,data:s.data,aiResponse:e,isErrorMessage:r}),o.index.showToast({title:"AI回复为空，请重试",icon:"none",duration:2e3});return}}else{console.warn("响应不是成功状态或缺少data:",{code:s.code,hasData:!!s.data,result:s});let e=s.message||((c=s.data)==null?void 0:c.message)||aiResponse||"发送失败，请稍后重试";if(s.code===401||s.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:r=>{r.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}if(e&&(e.includes("OPENAI_API_KEY")&&e.includes("未配置")||e.includes("OPENAI_API_KEY")&&e.includes("环境变量")||e.includes("请确保已配置")&&e.includes("OPENAI_API_KEY")||s.code===500&&e.includes("API")&&e.includes("Key")&&e.includes("未配置"))){o.index.showModal({title:"AI服务配置问题",content:`后端服务器未配置 OpenAI API Key。

请检查后端服务器环境变量配置（OPENAI_API_KEY）。

如果已配置但仍显示此错误，请查看后端日志获取详细信息。`,showCancel:!1,confirmText:"我知道了"});return}console.error("AI聊天错误详情:",{code:s.code,statusCode:s.statusCode,message:e,data:s.data}),o.index.showToast({title:e.length>50?e.substring(0,50)+"...":e,icon:"none",duration:4e3})}}catch(s){if(console.error("发送消息失败:",s),console.error("错误详情:",{errMsg:s.errMsg,statusCode:s.statusCode,data:s.data,message:s.message}),s.errMsg&&(s.errMsg.includes("EMPTY_RESPONSE")||s.errMsg.includes("request:fail"))){o.index.showModal({title:"连接失败",content:`无法连接到后端服务器，请检查：
1. 后端服务是否正在运行
2. 网络连接是否正常
3. 稍后重试`,showCancel:!1,confirmText:"我知道了"}),this.loading=!1;return}let e=s.message||s.data&&s.data.message||"";if(!e&&s.statusCode)if(s.statusCode===400)e="请求参数不正确或缺少必要字段";else if(s.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:n=>{n.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}else s.statusCode===403?e="没有权限访问该功能":s.statusCode===500&&(e="服务器错误，请稍后再试");!e&&s.errMsg&&s.errMsg.includes("fail")?s.errMsg.includes("SSL")||s.errMsg.includes("certificate")?e="SSL证书验证失败，请检查网络连接":s.errMsg.includes("timeout")||s.errMsg.includes("超时")?e="请求超时，AI回复可能需要更长时间，请稍后重试":e="无法连接到后端服务器，请检查网络连接或稍后重试":!e&&s.errMsg&&s.errMsg.includes("timeout")&&(e="请求超时，AI回复可能需要更长时间，请稍后重试"),e||(e="网络错误，请稍后再试"),o.index.showToast({title:e,icon:"none",duration:3e3})}finally{this.loading=!1,this.scrollToBottom()}},addMessage(t,i,l=!1){console.log("addMessage 被调用:",{role:t,content:i.substring(0,50)+"...",showTime:l,messagesCount:this.messages.length});const c=new Date,s=`${String(c.getHours()).padStart(2,"0")}:${String(c.getMinutes()).padStart(2,"0")}`;this.messages.push({role:t,content:i,time:s,showTime:l}),console.log("addMessage 完成，当前消息数量:",this.messages.length)},scrollToBottom(){this.$nextTick(()=>{this.scrollTop=99999})},goBack(){o.index.reLaunch({url:"/pages/home/home"})},showChatOptions(){o.index.showActionSheet({itemList:["清空聊天记录","查看心理分析","设置"],success:t=>{t.tapIndex===0?this.clearChat():t.tapIndex===1?this.showAnalysis():t.tapIndex===2&&o.index.showToast({title:"设置功能开发中",icon:"none"})}})},showMoreOptions(){o.index.showActionSheet({itemList:["查看聊天记录","导出聊天","关于小暖"],success:t=>{t.tapIndex===0?o.index.showToast({title:"聊天记录功能开发中",icon:"none"}):t.tapIndex===1?o.index.showToast({title:"导出功能开发中",icon:"none"}):t.tapIndex===2&&o.index.showModal({title:"关于小暖",content:"小暖是一位专门为盲人群体提供心理辅导的AI伙伴，温暖、理解、专业。",showCancel:!1})}})},clearChat(){o.index.showModal({title:"确认清空",content:"确定要清空所有聊天记录吗？",success:t=>{t.confirm&&(this.messages=[],this.sessionId=null,this.addMessage("assistant","你好，我是小暖，你的心理辅导伙伴。有什么想和我聊聊的吗？",!0),o.index.showToast({title:"已清空",icon:"success"}))}})},showAnalysis(){o.index.showToast({title:"心理分析功能开发中",icon:"none"})},showEmoji(){o.index.showToast({title:"表情功能开发中",icon:"none"})},showStickers(){o.index.showToast({title:"贴纸功能开发中",icon:"none"})},selectFile(){o.index.chooseImage({count:1,success:t=>{o.index.showToast({title:"图片选择功能开发中",icon:"none"})}})},showMoreInput(){o.index.showActionSheet({itemList:["语音输入","图片","位置"],success:t=>{o.index.showToast({title:"功能开发中",icon:"none"})}})},makeCall(){o.index.showToast({title:"语音通话功能开发中",icon:"none"})},makeVideoCall(){o.index.showToast({title:"视频通话功能开发中",icon:"none"})},toggleSidebar(){this.sidebarVisible=!this.sidebarVisible},onMoodChange(t){this.userInfo.mood=t.detail.value},async saveUserInfo(){if(!this.userInfo.name||!this.userInfo.age){o.index.showToast({title:"请填写姓名和年龄",icon:"none",duration:2e3});return}if(this.userInfo.age<1||this.userInfo.age>120){o.index.showToast({title:"年龄范围应在1-120之间",icon:"none",duration:2e3});return}this.savingInfo=!0,this.userInfoSaved=!1;try{const t={name:this.userInfo.name,age:Number(this.userInfo.age),currentMood:Number(this.userInfo.mood),recentConcern:this.userInfo.recentConcern||this.userInfo.symptom||""};this.userInfo.symptom&&!this.userInfo.recentConcern&&(t.recentConcern=this.userInfo.symptom);const i=await u.saveUserInfo(t);if(i.code===200)this.userInfoSaved=!0,o.index.showToast({title:"信息保存成功",icon:"success",duration:2e3}),setTimeout(()=>{this.userInfoSaved=!1},3e3);else throw new Error(i.message||"保存失败")}catch(t){console.error("保存用户信息失败:",t),o.index.showToast({title:t.message||"保存失败，请稍后重试",icon:"none",duration:3e3})}finally{this.savingInfo=!1}}}};function f(t,i,l,c,s,e){return o.e({a:o.o((...n)=>e.goBack&&e.goBack(...n)),b:o.o((...n)=>e.showChatOptions&&e.showChatOptions(...n)),c:o.o((...n)=>e.scrollToBottom&&e.scrollToBottom(...n)),d:o.o((...n)=>e.toggleSidebar&&e.toggleSidebar(...n)),e:o.o((...n)=>e.showMoreOptions&&e.showMoreOptions(...n)),f:o.o((...n)=>e.toggleSidebar&&e.toggleSidebar(...n)),g:o.o((...n)=>e.toggleSidebar&&e.toggleSidebar(...n)),h:s.userInfo.name,i:o.o(n=>s.userInfo.name=n.detail.value),j:s.userInfo.age,k:o.o(o.m(n=>s.userInfo.age=n.detail.value,{number:!0})),l:s.userInfo.symptom,m:o.o(n=>s.userInfo.symptom=n.detail.value),n:o.t(s.userInfo.mood===1?"很差":s.userInfo.mood===10?"很好":"一般"),o:s.userInfo.mood,p:o.o((...n)=>e.onMoodChange&&e.onMoodChange(...n)),q:s.userInfo.recentConcern,r:o.o(n=>s.userInfo.recentConcern=n.detail.value),s:o.t(s.savingInfo?"保存中...":"保存信息"),t:o.o((...n)=>e.saveUserInfo&&e.saveUserInfo(...n)),v:s.savingInfo,w:s.userInfoSaved},s.userInfoSaved?{}:{},{x:s.sidebarVisible?1:"",y:o.f(s.messages,(n,r,d)=>o.e({a:n.showTime},n.showTime?{b:o.t(n.time)}:{},{c:n.role==="assistant"},n.role==="assistant"?{d:h._imports_0,e:o.t(n.content)}:{f:o.t(n.content)},{g:r})),z:s.loading},s.loading?{A:h._imports_0}:{},{B:s.scrollTop,C:o.o((...n)=>e.showEmoji&&e.showEmoji(...n)),D:o.o((...n)=>e.showStickers&&e.showStickers(...n)),E:o.o((...n)=>e.selectFile&&e.selectFile(...n)),F:o.o((...n)=>e.showMoreInput&&e.showMoreInput(...n)),G:o.o((...n)=>e.scrollToBottom&&e.scrollToBottom(...n)),H:o.o((...n)=>e.sendMessage&&e.sendMessage(...n)),I:s.loading,J:s.inputText,K:o.o(n=>s.inputText=n.detail.value),L:o.o((...n)=>e.makeCall&&e.makeCall(...n)),M:o.o((...n)=>e.makeVideoCall&&e.makeVideoCall(...n))})}const m=o._export_sfc(g,[["render",f],["__scopeId","data-v-464144ae"]]);wx.createPage(m);
