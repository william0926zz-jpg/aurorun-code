"use strict";const o=require("../../common/vendor.js"),u=require("../../api/aiChat.js"),a=require("../../utils/request.js"),h=require("../../common/assets.js"),f={data(){return{messages:[],inputText:"",loading:!1,sessionId:null,scrollTop:0,sidebarVisible:!1,userInfo:{name:"",age:null,symptom:"",mood:5,recentConcern:""},savingInfo:!1,userInfoSaved:!1}},onLoad(){if(!a.api.getToken()){o.index.showModal({title:"需要登录",content:"使用AI聊天功能需要先登录，是否前往登录页面？",confirmText:"去登录",cancelText:"取消",success:i=>{i.confirm?o.index.reLaunch({url:"/pages/login/login"}):o.index.navigateBack()}});return}a.api.get("/api/health").then(i=>{console.log("AI调试 /api/health 响应:",i),i&&i.__http&&(console.log("AI调试 命中后端URL:",i.__http.requestUrl),console.log("AI调试 RequestId:",i.__http.requestId))}).catch(i=>{console.warn("AI调试 /api/health 失败:",i)}),this.addMessage("assistant","你好，我是小暖，你的心理辅导伙伴。有什么想和我聊聊的吗？",!0)},methods:{async sendMessage(){var c,l;if(!this.inputText.trim()||this.loading)return;if(!a.api.getToken()){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:n=>{n.confirm&&o.index.reLaunch({url:"/pages/login/login"})}});return}const i=this.inputText.trim();this.inputText="",this.addMessage("user",i,!0),this.scrollToBottom(),this.loading=!0;try{if(!this.sessionId){const s=await u.createSession("与小暖的对话");if(s.code===200&&s.data&&s.data.sessionId)this.sessionId=s.data.sessionId;else{const e=s.message||((c=s.data)==null?void 0:c.message)||"创建会话失败";if(s.code===401||s.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:r=>{r.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}o.index.showToast({title:e,icon:"none",duration:3e3});return}}const n=await u.sendMessage(this.sessionId,i);if(console.log("AI聊天响应:",{code:n.code,message:n.message,data:n.data,fullResult:n}),n.code===200&&n.data){const s=n.data.aiResponse||n.data.response||n.data.content||n.data.text||n.data.message||"",e=s.toLowerCase(),r=e&&(e.includes("抱歉")&&e.includes("暂不可用")||e.includes("暂不可用")&&(e.includes("api")||e.includes("key"))||e.includes("请确保已配置")&&(e.includes("环境变量")||e.includes("openai_api_key")||e.includes("deepseek"))||e.includes("无法回复")&&e.includes("稍后再试")||e.includes("openai_api_key")&&(e.includes("未配置")||e.includes("环境变量"))||e.includes("api key")&&(e.includes("not")||e.includes("missing")||e.includes("未配置"))||e.includes("api服务")&&e.includes("不可用"));if(s&&!r){n.data.sessionId&&(this.sessionId=n.data.sessionId),this.addMessage("assistant",s,!0),n.data.analysis&&console.log("心理分析:",n.data.analysis);return}else if(r){const d=s||"AI服务暂不可用";if(d.includes("OPENAI_API_KEY")||d.includes("API")&&d.includes("Key")){o.index.showModal({title:"AI服务配置问题",content:`后端服务器未配置 AI API Key。

请检查后端服务器环境变量配置（DeepSeek 或 OpenAI API Key）。`,showCancel:!1,confirmText:"我知道了"});return}else{o.index.showToast({title:d,icon:"none",duration:3e3});return}}else{console.warn("后端返回成功，但缺少 AI 回复内容:",n.data),o.index.showToast({title:"AI回复为空，请重试",icon:"none",duration:2e3});return}}else{let s=n.message||((l=n.data)==null?void 0:l.message)||aiResponse||"发送失败，请稍后重试";if(n.code===401||n.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:r=>{r.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}if(s&&(s.includes("OPENAI_API_KEY")&&s.includes("未配置")||s.includes("OPENAI_API_KEY")&&s.includes("环境变量")||s.includes("请确保已配置")&&s.includes("OPENAI_API_KEY")||n.code===500&&s.includes("API")&&s.includes("Key")&&s.includes("未配置"))){o.index.showModal({title:"AI服务配置问题",content:`后端服务器未配置 AI API Key。

请检查后端服务器环境变量配置（DeepSeek 或 OpenAI API Key）。

如果已配置但仍显示此错误，请查看后端日志获取详细信息。`,showCancel:!1,confirmText:"我知道了"});return}console.error("AI聊天错误详情:",{code:n.code,statusCode:n.statusCode,message:s,data:n.data}),o.index.showToast({title:s.length>50?s.substring(0,50)+"...":s,icon:"none",duration:4e3})}}catch(n){console.error("发送消息失败:",n),console.error("错误详情:",{errMsg:n.errMsg,statusCode:n.statusCode,data:n.data,message:n.message});let s=n.message||n.data&&n.data.message||"";if(!s&&n.statusCode)if(n.statusCode===400)s="请求参数不正确或缺少必要字段";else if(n.statusCode===401){o.index.showModal({title:"登录已过期",content:"您的登录已过期，请重新登录后继续使用AI聊天功能。",confirmText:"去登录",cancelText:"取消",success:e=>{e.confirm&&(a.api.setToken(""),a.api.setRefreshToken(""),o.index.reLaunch({url:"/pages/login/login"}))}});return}else n.statusCode===403?s="没有权限访问该功能":n.statusCode===500&&(s="服务器错误，请稍后再试");!s&&n.errMsg&&n.errMsg.includes("fail")?s="无法连接到后端服务器，请检查网络或后端服务":!s&&n.errMsg&&n.errMsg.includes("timeout")&&(s="请求超时，AI回复可能需要更长时间"),s||(s="网络错误，请稍后再试"),o.index.showToast({title:s,icon:"none",duration:3e3})}finally{this.loading=!1,this.scrollToBottom()}},addMessage(t,i,c=!1){const l=new Date,n=`${String(l.getHours()).padStart(2,"0")}:${String(l.getMinutes()).padStart(2,"0")}`;this.messages.push({role:t,content:i,time:n,showTime:c})},scrollToBottom(){this.$nextTick(()=>{this.scrollTop=99999})},goBack(){o.index.reLaunch({url:"/pages/home/home"})},showChatOptions(){o.index.showActionSheet({itemList:["清空聊天记录","查看心理分析","设置"],success:t=>{t.tapIndex===0?this.clearChat():t.tapIndex===1?this.showAnalysis():t.tapIndex===2&&o.index.showToast({title:"设置功能开发中",icon:"none"})}})},showMoreOptions(){o.index.showActionSheet({itemList:["查看聊天记录","导出聊天","关于小暖"],success:t=>{t.tapIndex===0?o.index.showToast({title:"聊天记录功能开发中",icon:"none"}):t.tapIndex===1?o.index.showToast({title:"导出功能开发中",icon:"none"}):t.tapIndex===2&&o.index.showModal({title:"关于小暖",content:"小暖是一位专门为盲人群体提供心理辅导的AI伙伴，温暖、理解、专业。",showCancel:!1})}})},clearChat(){o.index.showModal({title:"确认清空",content:"确定要清空所有聊天记录吗？",success:t=>{t.confirm&&(this.messages=[],this.sessionId=null,this.addMessage("assistant","你好，我是小暖，你的心理辅导伙伴。有什么想和我聊聊的吗？",!0),o.index.showToast({title:"已清空",icon:"success"}))}})},showAnalysis(){o.index.showToast({title:"心理分析功能开发中",icon:"none"})},showEmoji(){o.index.showToast({title:"表情功能开发中",icon:"none"})},showStickers(){o.index.showToast({title:"贴纸功能开发中",icon:"none"})},selectFile(){o.index.chooseImage({count:1,success:t=>{o.index.showToast({title:"图片选择功能开发中",icon:"none"})}})},showMoreInput(){o.index.showActionSheet({itemList:["语音输入","图片","位置"],success:t=>{o.index.showToast({title:"功能开发中",icon:"none"})}})},makeCall(){o.index.showToast({title:"语音通话功能开发中",icon:"none"})},makeVideoCall(){o.index.showToast({title:"视频通话功能开发中",icon:"none"})},toggleSidebar(){this.sidebarVisible=!this.sidebarVisible},onMoodChange(t){this.userInfo.mood=t.detail.value},async saveUserInfo(){if(!this.userInfo.name||!this.userInfo.age){o.index.showToast({title:"请填写姓名和年龄",icon:"none",duration:2e3});return}if(this.userInfo.age<1||this.userInfo.age>120){o.index.showToast({title:"年龄范围应在1-120之间",icon:"none",duration:2e3});return}this.savingInfo=!0,this.userInfoSaved=!1;try{const t={name:this.userInfo.name,age:Number(this.userInfo.age),currentMood:Number(this.userInfo.mood),recentConcern:this.userInfo.recentConcern||this.userInfo.symptom||""};this.userInfo.symptom&&!this.userInfo.recentConcern&&(t.recentConcern=this.userInfo.symptom);const i=await u.saveUserInfo(t);if(i.code===200)this.userInfoSaved=!0,o.index.showToast({title:"信息保存成功",icon:"success",duration:2e3}),setTimeout(()=>{this.userInfoSaved=!1},3e3);else throw new Error(i.message||"保存失败")}catch(t){console.error("保存用户信息失败:",t),o.index.showToast({title:t.message||"保存失败，请稍后重试",icon:"none",duration:3e3})}finally{this.savingInfo=!1}}}};function g(t,i,c,l,n,s){return o.e({a:o.o((...e)=>s.goBack&&s.goBack(...e)),b:o.o((...e)=>s.showChatOptions&&s.showChatOptions(...e)),c:o.o((...e)=>s.scrollToBottom&&s.scrollToBottom(...e)),d:o.o((...e)=>s.toggleSidebar&&s.toggleSidebar(...e)),e:o.o((...e)=>s.showMoreOptions&&s.showMoreOptions(...e)),f:o.o((...e)=>s.toggleSidebar&&s.toggleSidebar(...e)),g:o.o((...e)=>s.toggleSidebar&&s.toggleSidebar(...e)),h:n.userInfo.name,i:o.o(e=>n.userInfo.name=e.detail.value),j:n.userInfo.age,k:o.o(o.m(e=>n.userInfo.age=e.detail.value,{number:!0})),l:n.userInfo.symptom,m:o.o(e=>n.userInfo.symptom=e.detail.value),n:o.t(n.userInfo.mood===1?"很差":n.userInfo.mood===10?"很好":"一般"),o:n.userInfo.mood,p:o.o((...e)=>s.onMoodChange&&s.onMoodChange(...e)),q:n.userInfo.recentConcern,r:o.o(e=>n.userInfo.recentConcern=e.detail.value),s:o.t(n.savingInfo?"保存中...":"保存信息"),t:o.o((...e)=>s.saveUserInfo&&s.saveUserInfo(...e)),v:n.savingInfo,w:n.userInfoSaved},n.userInfoSaved?{}:{},{x:n.sidebarVisible?1:"",y:o.f(n.messages,(e,r,d)=>o.e({a:e.showTime},e.showTime?{b:o.t(e.time)}:{},{c:e.role==="assistant"},e.role==="assistant"?{d:h._imports_0,e:o.t(e.content)}:{f:o.t(e.content)},{g:r})),z:n.loading},n.loading?{A:h._imports_0}:{},{B:n.scrollTop,C:o.o((...e)=>s.showEmoji&&s.showEmoji(...e)),D:o.o((...e)=>s.showStickers&&s.showStickers(...e)),E:o.o((...e)=>s.selectFile&&s.selectFile(...e)),F:o.o((...e)=>s.showMoreInput&&s.showMoreInput(...e)),G:o.o((...e)=>s.scrollToBottom&&s.scrollToBottom(...e)),H:o.o((...e)=>s.sendMessage&&s.sendMessage(...e)),I:n.loading,J:n.inputText,K:o.o(e=>n.inputText=e.detail.value),L:o.o((...e)=>s.makeCall&&s.makeCall(...e)),M:o.o((...e)=>s.makeVideoCall&&s.makeVideoCall(...e))})}const I=o._export_sfc(f,[["render",g],["__scopeId","data-v-1a49ba32"]]);wx.createPage(I);
